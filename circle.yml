# see orb options at
# https://github.com/cypress-io/circleci-orb
version: 2.1
orbs:
  cypress: cypress-io/cypress@1

jobs:
  first:
    executor: cypress/base-10
    steps:
      - checkout
      - run: pwd
      - run: ls -la .
      - persist_to_workspace:
          root: ~/
          paths:
          - project

  second:
    executor: cypress/base-10
    steps:
      - attach_workspace:
          at: ~/
      - run: pwd
      - run: ls -la .
      # add another file
      - run: echo "Job node index $CIRCLE_NODE_INDEX" > foo.json
      - persist_to_workspace:
          root: ~/
          paths:
          - project/foo.json
      - run: ls -la .

  third:
    executor: cypress/base-10
    steps:
      - attach_workspace:
          at: ~/
      - run: pwd
      - run: ls -la .
      - run: ls -la ~
      - run: ls -la /

workflows:
  build:
    jobs:
      - first
      - second:
          requires:
            - first
      - third:
          requires:
            - second

#   second:
#     executor: cypress/base-10
#     steps:
#       - attach_workspace:
#           at: ~/
#       - run: ls -la /
#       - run: ls -la .
#       - run: ls -la coverage-part || true
#       - run: mkdir .nyc_output || true
#       - run: npx nyc merge coverage-part
#       - run: mv coverage.json .nyc_output/out.json
#       - run: ls -la .nyc_output
#       - store_artifacts:
#           path: .nyc_output/out.json
#       - run:
#           name: generate coverage report
#           command: |
#             npx nyc report \
#               --reporter lcov --reporter text-summary \
#               --report-dir coverage
#       - store_artifacts:
#           path: coverage

#       # send code coverage to coveralls.io
#       # https://coveralls.io/github/cypress-io/cypress-example-realworld
#       - run:
#           command: npm run coveralls || true

#       # - run:
#       #     # https://docs.coveralls.io/parallel-build-webhook
#       #     name: Tell Coveralls all jobs are done
#       #     command: |
#       #       curl https://coveralls.io/webhook/?repo_token=$COVERALLS_REPO_TOKEN \
#       #         -d "payload[build_num]=$CIRCLE_WORKFLOW_ID&payload[status]=done"

# workflows:
#   build:
#     jobs:
#       - cypress/install:
#           executor: cypress/base-10
#           pre-steps:
#             - run: npm config set unsafe-perm true
#       - cypress/run:
#           requires:
#             - cypress/install
#           executor: cypress/base-10
#           parallel: true
#           parallelism: 4
#           no-workspace: true
#           start: npm run start:coverage
#           wait-on: http://localhost:4100
#           record: true
#           post-steps:
#             - store_artifacts:
#                 path: coverage
#             # if this machine had no tests to run
#             # there will be no coverage report
#             - run: npx nyc report --reporter=text || true

#             # collect all code coverage reports
#             - run: mkdir coverage-part || true
#             - run: touch coverage-part/.placeholder || true
#             - run: cp coverage/coverage-final.json coverage-part/coverage-$CIRCLE_NODE_INDEX.json || true
#             - run: ls -la coverage-part
#             - persist_to_workspace:
#                 root: coverage-part
#                 paths:
#                   - "*.json"

#             # send code coverage to coveralls.io
#             # https://coveralls.io/github/cypress-io/cypress-example-realworld
#             # but because we run tests in parallel, tell Coveralls
#             # to merge the reports into a single complete one
#             # https://docs.coveralls.io/parallel-build-webhook
#             # - run:
#             #     environment:
#             #       COVERALLS_PARALLEL: 1
#             #     command: CIRCLE_BUILD_NUM=$CIRCLE_WORKFLOW_ID npm run coveralls || true
#       - notify_coveralls:
#           requires:
#             - cypress/run
